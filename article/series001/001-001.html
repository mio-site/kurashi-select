<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>【2025年最新】楽天レディースファッション・リアル売れ筋TOP10</title>

    <!-- SEO & Viewport Meta Tags -->
    <meta name="description" content="楽天レディースファッションの2025年最新売れ筋ランキングをデータで分析。価格、レビュー評価、人気度をインタラクティブなグラフと比較し、あなたに最適な一着を見つけます。">
    <meta content='width=device-width,initial-scale=1.0,minimum-scale=1.0' name='viewport'/>
    <meta name="theme-color" content="#A88767">

    <!-- Icons & PWA -->
    <link rel="icon" type="image/png" href="../../icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
    <link rel="manifest" href="../../manifest.webmanifest">

    <!-- Tailwindは初期描画で必要なため defer しない -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Stylesheets (CSS 遅延読み込みを適用) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <style>
        :root {
            --bg: #FDFBF8;
            --text: #4B423A;
            --primary: #A88767;
            --accent: #8B7E74;
            --card: #FFFFFF;
            --muted: #6B7280; /* gray-500 */
        }
        .dark {
            --bg: #1B1A19;
            --text: #EAE6DF;
            --primary: #C5A982;
            --accent: #9A8C7F;
            --card: #23211F;
            --muted: #9CA3AF; /* gray-400 */
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .bg-accent { background-color: var(--accent); }
        .border-accent { border-color: var(--accent); }
        .text-muted { color: var(--muted); }
        .transition-all { transition: all 0.3s ease-in-out; }
        .transform-gpu { transform: translateZ(0); }
        .card-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card-shadow-hover:hover { box-shadow: 0 8px 25px rgba(75, 66, 58, 0.1); }
        .chart-container { position: relative; height: 450px; width: 100%;}
        .dark .bg-white { background-color: var(--card); }
        .dark .text-gray-600 { color: var(--muted); }
        .chip { border: 1px solid rgba(0,0,0,0.08); padding: 4px 10px; border-radius: 9999px; font-size: 12px; }
        .chip-selected { outline: 2px solid var(--primary); background-color: rgba(168,135,103,0.1); }
        .sticky-bar { position: sticky; bottom: 12px; z-index: 40; }
        .floating { position: fixed; right: 16px; bottom: 16px; z-index: 50; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal { max-width: 960px; width: calc(100% - 2rem); background: var(--card); color: var(--text); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .range { accent-color: var(--primary); }
        .btn { cursor: pointer; }
        .highlight-ring { box-shadow: 0 0 0 4px rgba(168,135,103,0.45) inset; transition: box-shadow .3s ease; }
    </style>
</head>
<body class="antialiased" style="display: none;">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">

        <header class="text-center mb-12 md:mb-20">
            <h1 class="text-3xl md:text-5xl font-bold text-primary mb-2">夏の選択</h1>
            <p class="text-lg md:text-xl text-gray-600">データで読み解く、楽天「本当に売れてる」レディースファッションTOP10</p>
        </header>

        <section id="intro" class="max-w-3xl mx-auto text-center mb-10 md:mb-14">
            <h2 class="text-2xl md:text-3xl font-bold mb-4">賢い買い物は、情報から。</h2>
            <p class="text-base md:text-lg leading-relaxed">
                「みんなが何を買っているの？」「本当に良い商品はどれ？」夏のファッション選びは、選択肢が多すぎて迷ってしまいます。このガイドでは、楽天市場の最新ランキングデータを基に、「価格」「レビュー評価」「人気度（レビュー数）」を徹底分析。あなたの価値観に合った最高の1着を見つけるための、インタラクティブな旅にご案内します。
            </p>
        </section>

        <!-- 総合トップ3（ファーストビュー強化） -->
        <section id="top3" class="mb-10 md:mb-14">
            <div class="max-w-4xl mx-auto text-center mb-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-2">総合トップ3</h2>
                <p class="text-xs md:text-sm text-muted">人気・評価・価格のバランスで厳選。まずはここから。</p>
            </div>
            <div id="top3-container" class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8"></div>
        </section>

        <!-- コントロールパネル -->
        <section id="controls" class="bg-white dark:bg-opacity-80 backdrop-blur-sm p-4 sm:p-6 md:p-8 rounded-2xl card-shadow max-w-4xl mx-auto mb-10 md:mb-14">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                    <div class="flex-1">
                        <label for="search-box" class="block text-sm mb-1 text-muted">キーワード検索</label>
                        <input id="search-box" type="search" placeholder="例: UV, ワンピース, パンツ…" class="w-full border rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    </div>
                    <div class="flex gap-2 items-end">
                        <button id="btn-dark-toggle" class="btn bg-accent text-white px-4 py-2 rounded-xl card-shadow-hover" aria-pressed="false">🌙 ダーク</button>
                        <button id="btn-install" class="btn bg-accent text-white px-4 py-2 rounded-xl card-shadow-hover hidden">⬇️ インストール</button>
                        <button id="btn-reset" class="btn bg-white border px-4 py-2 rounded-xl card-shadow-hover">リセット</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-1 text-muted">価格帯（円）</label>
                        <div class="flex items-center gap-2">
                            <input id="price-min" type="number" class="w-24 border rounded-lg px-2 py-1" min="0" step="100" />
                            <span class="text-muted">〜</span>
                            <input id="price-max" type="number" class="w-24 border rounded-lg px-2 py-1" min="0" step="100" />
                            <input id="price-range" type="range" min="0" max="100" value="0" class="range flex-1" aria-label="価格範囲(ショートカット)" />
                        </div>
                    </div>
                    <div>
                        <label for="filter-rating" class="block text-sm mb-1 text-muted">最低評価</label>
                        <input id="filter-rating" type="range" min="0" max="5" step="0.1" value="0" class="range w-full" />
                        <div class="text-xs text-muted mt-1"><span id="label-rating">0.0</span> 以上</div>
                    </div>
                    <div>
                        <label for="filter-review" class="block text-sm mb-1 text-muted">最低レビュー件数</label>
                        <input id="filter-review" type="range" min="0" max="10000" step="100" value="0" class="range w-full" />
                        <div class="text-xs text-muted mt-1"><span id="label-review">0</span> 件以上</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center gap-2 text-sm"><input id="filter-fav" type="checkbox" class="accent-[var(--primary)]"><span>お気に入りのみ</span></label>
                        <div class="ml-auto flex gap-2">
                            <button id="btn-sort-score" class="btn bg-primary text-white px-4 py-2 rounded-xl card-shadow-hover">✨ おすすめ順</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="text-sm mb-2 text-muted">タグで絞り込み</div>
                    <div id="tags-container" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="text-xs text-muted" id="result-summary" aria-live="polite"></div>
            </div>
        </section>

        <section id="chart-analysis" class="mb-16 md:mb-24">
            <div class="max-w-4xl mx-auto text-center mb-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-2">ランキングの全体像：人気と価格のマップ</h2>
                <p class="text-sm md:text-base text-muted">右上かつ円が大きいほど「人気も評価も高い」傾向。点をタップすると該当カードへ移動します。</p>
            </div>
            <details class="max-w-4xl mx-auto bg-white rounded-2xl card-shadow">
                <summary class="list-none cursor-pointer p-4 sm:p-5 md:p-6 flex items-center justify-between">
                    <span class="font-semibold text-primary">人気×価格の関係を見る（グラフを開く）</span>
                    <span class="text-xs text-muted">理解の助けに。買い物は下のリストからすぐ可能です。</span>
                </summary>
                                 <div class="p-4 sm:p-6 md:p-8 pt-0">
                     <div class="chart-container min-h-[400px] w-full">
                         <canvas id="productsChart" style="width: 100%; height: 400px;"></canvas>
                     </div>
                     <p class="mt-4 text-[11px] text-muted">データ更新: <span id="data-updated"></span>｜出典: 楽天市場ランキング｜算出: 価格・評価・人気の総合</p>
                 </div>
            </details>
        </section>

        <section id="interactive-selection" class="mb-16 md:mb-24">
            <div class="max-w-3xl mx-auto text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-4">あなたの選択：何を基準に選びますか？</h2>
                <p class="text-base md:text-lg leading-relaxed mb-8">
                    価値観は人それぞれ。あなたの探し方に合わせて、商品をご紹介します。下のボタンから、あなたの考えに近い方を選んでください。
                </p>
                <div class="flex flex-col sm:flex-row justify-center gap-4" role="tablist" aria-label="並び替え">
                    <button id="btn-sort-rank" role="tab" aria-selected="true" class="w-full sm:w-auto bg-primary text-white font-bold py-3 px-8 rounded-full transition-all transform-gpu hover:scale-105 card-shadow-hover ring-2 ring-offset-2 ring-primary">
                        👑 人気ランキング順
                    </button>
                    <button id="btn-sort-price" role="tab" aria-selected="false" class="w-full sm:w-auto bg-accent text-white font-bold py-3 px-8 rounded-full transition-all transform-gpu hover:scale-105 card-shadow-hover">
                        💰 価格が安い順
                    </button>
                    <button id="btn-sort-review" role="tab" aria-selected="false" class="w-full sm:w-auto bg-accent text-white font-bold py-3 px-8 rounded-full transition-all transform-gpu hover:scale-105 card-shadow-hover">
                        ⭐ 評価が高い順
                    </button>
                </div>
            </div>

            <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                <!-- 商品カードがここに動的に挿入されます -->
            </div>
        </section>
        
        <section id="conclusion" class="max-w-3xl mx-auto text-center mt-12">
             <h2 class="text-2xl md:text-3xl font-bold mb-4">最終的な結論</h2>
             <div id="recommendation-text" class="bg-white p-6 md:p-8 rounded-2xl card-shadow text-left leading-relaxed">
                <p class="font-bold text-lg mb-3">2025年夏のトレンドは「高機能・体型カバー・高コスパ」</p>
                <p>ランキング全体を見ると、単にお洒落なだけでなく、<strong>UVカットや接触冷感などの「機能性」</strong>、そして気になる部分を隠せる<strong>「体型カバー力」</strong>を兼ね備えたアイテムが圧倒的な支持を集めていることがわかります。特に、1,000円〜2,000円台の価格帯で驚くほどの高機能を実現したUVパーカーやルームウェアは、賢い消費者が選ぶ鉄板アイテムと言えるでしょう。</p>
                <p class="mt-4">あなたが何を重視するかにかかわらず、このTOP10の中には必ず満足できる一着があります。ぜひ、この夏の最高のパートナーを見つけてください。</p>
             </div>
        </section>

        <!-- 比較バー（sticky） -->
        <div id="compare-bar" class="sticky-bar max-w-4xl mx-auto mt-6 hidden">
            <div class="bg-white rounded-2xl card-shadow p-3 md:p-4 flex items-center gap-3">
                <div class="text-sm flex-1"><span id="compare-count">0</span> 件選択中（最大3件）</div>
                <div class="flex gap-2">
                    <button id="btn-compare" class="btn bg-primary text-white px-4 py-2 rounded-xl disabled:opacity-40" disabled>🔍 比較する</button>
                    <button id="btn-compare-clear" class="btn border px-4 py-2 rounded-xl">クリア</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ------- データ定義
        const productsData = [
          {
            "rank": 1, "itemName": "＼18％OFFクーポン／UV パーカー 冷感 -7℃", "itemPrice": 1980, "reviewCount": 13633, "reviewAverage": 4.33, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00tgx3k.qgo2xc2d.g00tgx3k.qgo2y170/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnityukan0715%2Fqqdou7009a%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/nityukan0715/cabinet/10771143/chenai4t_01n.jpg?_ex=128x128", "catchcopy": "紫外線遮蔽率99％！軽やかな冷感素材で快適キープ", "description": "栄えある第1位。UPF50+、接触冷感、通気性、取り外し可能なサンバイザーまで備えた「着る日焼け止め」。圧倒的な機能性と1万件を超えるレビュー数がその実力を証明しています。夏のあらゆるシーンで活躍する最強の一枚です。"
          },
          {
            "rank": 2, "itemName": "【クーポン利用】体型カバー水着5点セット", "itemPrice": 7580, "reviewCount": 568, "reviewAverage": 4.23, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00qqehk.qgo2x195.g00qqehk.qgo2ye8e/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Ftouhuzi%2Fvikir5189%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/touhuzi/cabinet/aka_sam/vikir5189_os_aka20.jpg?_ex=128x128", "catchcopy": "水陸両用！ぽっちゃりさんも安心の5点セット", "description": "ラッシュガードからレギンスまで全て揃った豪華5点セット。気になる部分を完璧にカバーしつつ、スタイリッシュに見えるデザインが魅力。UVカット率も99.9%以上で、水辺のアクティビティを存分に楽しめます。"
          },
          {
            "rank": 3, "itemName": "UVカット率99%以上 タンキニ水着4点セット", "itemPrice": 4780, "reviewCount": 2521, "reviewAverage": 4.26, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00r62fk.qgo2xdf0.g00r62fk.qgo2y08a/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fteddyshop%2Fhys2861%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/teddyshop/cabinet/mizugi40/hys2861x1tr_6.jpg?_ex=128x128", "catchcopy": "気負わないヘルシーコーデ！洋服みたいな水着セット", "description": "トレンドのビスチェ風デザインがお洒落な4点セット。洋服感覚で着られるので、水着に抵抗がある方にもおすすめ。長袖シャツとハーフパンツで露出を抑えつつ、しっかりと体型をカバーしてくれます。"
          },
          {
            "rank": 4, "itemName": "＼先着1枚842円！／さらてろルームウェア上下セット", "itemPrice": 990, "reviewCount": 9283, "reviewAverage": 4.33, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00q8qjk.qgo2xf81.g00q8qjk.qgo2ycff/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fdarkangel%2Fto2305-1114%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/darkangel/cabinet/11667147/07/1114-main-250723-2.jpg?_ex=128x128", "catchcopy": "＼ロングセラー／リブ生地ルームウェア上下セット", "description": "肌に馴染む「さらてろ」感がやみつきになるルームウェア。裾を自分でカットできるので、どんな身長の人にもフィットします。リラックスできる着心地と可愛いデザインで、おうち時間を格上げするアイテムです。"
          },
          {
            "rank": 5, "itemName": "【クーポンで2,450円】接触冷感ストライプワイドパンツ", "itemPrice": 4900, "reviewCount": 257, "reviewAverage": 4.53, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00synkk.qgo2xe94.g00synkk.qgo2y989/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fsljapan1%2Fsa9517%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/sljapan1/cabinet/07985602/sa9517/sa9517_top2.jpg?_ex=128x128", "catchcopy": "＼楽天1位！6冠達成／選べる丈のひんやりストライプパンツ", "description": "穿いた瞬間ひんやりする接触冷感素材で、夏に最適なワイドパンツ。縦のストライプ柄が脚長効果を演出し、ゆったりシルエットで体型もカバー。楽ちんなのにキレイめに見える、大人のためのカジュアルパンツです。"
          },
          {
            "rank": 6, "itemName": "UVカット率99%以上 長袖ラッシュガード5点セット", "itemPrice": 4480, "reviewCount": 6803, "reviewAverage": 4.38, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00r62fk.qgo2xdf0.g00r62fk.qgo2y08a/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fteddyshop%2Fhys2128%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/teddyshop/cabinet/mizugi40/hys2128x1tr_2.jpg?_ex=128x128", "catchcopy": "しっかりカバーできる長袖＆レギンス☆動きやすさも◎", "description": "6000件以上のレビューが信頼の証。日焼け対策と体型カバーを両立したいならこの5点セットが最適。動きやすさも考慮されており、フィットネスや水中ウォーキングにも対応。幅広いサイズ展開も魅力です。"
          },
          {
            "rank": 7, "itemName": "「新感覚」穿いていて疲れないデニムパンツ", "itemPrice": 2999, "reviewCount": 8145, "reviewAverage": 4.5, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00s53ck.qgo2x590.g00s53ck.qgo2yac3/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fhhh-style%2Fjp144%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/hhh-style/cabinet/50227/jp144-1.jpg?_ex=128x128", "catchcopy": "カラーver追加！トール丈も選べるストレッチデニム", "description": "本格的な見た目からは想像できないほどのストレッチ性で、一日中快適に過ごせる「疲れない」デニム。ゆったりとしたストレートシルエットが体型を拾わず、誰でも美脚見えが叶います。豊富なサイズと丈から選べるのも嬉しいポイント。"
          },
          {
            "rank": 8, "itemName": "2点で完結！お腹が見えないインナー一体型水着セット", "itemPrice": 3480, "reviewCount": 372, "reviewAverage": 4.52, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00tcj3k.qgo2x72c.g00tcj3k.qgo2y354/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fdearcologne%2Fts001set%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/dearcologne/cabinet/sw/ts001set-bbb.jpg?_ex=128x128", "catchcopy": "インナーがくっついた便利なセパレート水着セット♪", "description": "着替えが面倒という悩みを解決する画期的な水着。トップスとパンツにインナーが一体化しており、着替えが非常にスムーズ。お腹が見えない設計で、小さなお子様がいるママにも安心して着用いただけます。"
          },
          {
            "rank": 9, "itemName": "＼半額クーポン配布中！／完全防備UVパーカー", "itemPrice": 999, "reviewCount": 9262, "reviewAverage": 4.1, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00q8qjk.qgo2xf81.g00q8qjk.qgo2ycff/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fdarkangel%2Fotg1704-0115%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/darkangel/cabinet/11667147/07/0115-main-250722.jpg?_ex=128x128", "catchcopy": "1枚3役！UPF50+ 着たほうが涼しい、羽織る日焼け止め", "description": "1位の商品と双璧をなす人気のUVパーカー。こちらもUPF50+、接触冷感、フード、指穴付きと機能性抜群。特に価格の安さが驚異的で、コストパフォーマンスを重視するならこれ以上の選択肢はありません。"
          },
          {
            "rank": 10, "itemName": "＼先着1枚1,615円〜／選べる2タイプマキシワンピース", "itemPrice": 1899, "reviewCount": 3378, "reviewAverage": 4.24, "affiliateUrl": "https://hb.afl.rakuten.co.jp/hgc/g00q8qjk.qgo2xf81.g00q8qjk.qgo2ycff/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fdarkangel%2Fop2502-4732%2F&rafcid=wsc_i_ra_1014243036473883403",
            "imageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/darkangel/cabinet/11667147/07/4732-main-250708-1.jpg?_ex=128x128", "catchcopy": "気分で選べる！シンプルで大人かわいいマキシワンピース", "description": "1枚でコーディネートが完成する、夏の頼れるマキシワンピース。体のラインを拾わない美しいシルエットと、さらっとしたスムースコットン素材が魅力。豊富なデザインと丈から選べるので、理想の一枚が見つかります。"
          }
        ];

        const resultsContainer = document.getElementById('results-container');
        const sortButtons = {
            rank: document.getElementById('btn-sort-rank'),
            price: document.getElementById('btn-sort-price'),
            review: document.getElementById('btn-sort-review')
        };

        // 追加UI要素
        const searchBox = document.getElementById('search-box');
        const priceMinInput = document.getElementById('price-min');
        const priceMaxInput = document.getElementById('price-max');
        const priceRangeQuick = document.getElementById('price-range');
        const filterRating = document.getElementById('filter-rating');
        const filterReview = document.getElementById('filter-review');
        const labelRating = document.getElementById('label-rating');
        const labelReview = document.getElementById('label-review');
        const favOnlyCheckbox = document.getElementById('filter-fav');
        const btnReset = document.getElementById('btn-reset');
        const btnSortScore = document.getElementById('btn-sort-score');
        const tagsContainer = document.getElementById('tags-container');
        const resultSummary = document.getElementById('result-summary');
        const compareBar = document.getElementById('compare-bar');
        const compareCount = document.getElementById('compare-count');
        const btnCompare = document.getElementById('btn-compare');
        const btnCompareClear = document.getElementById('btn-compare-clear');
        const btnDarkToggle = document.getElementById('btn-dark-toggle');
        const btnInstall = document.getElementById('btn-install');

        // 比較モーダル（動的生成）
        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.innerHTML = `
            <div class="modal p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">商品比較</h3>
                    <button id="modal-close" class="btn border px-3 py-1 rounded-lg">閉じる</button>
                </div>
                <div id="compare-body" class="overflow-x-auto"></div>
            </div>
        `;
        document.body.appendChild(modalBackdrop);

        // ------- ユーティリティ
        const debounce = (fn, ms = 250) => {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
        };
        const getFavorites = () => new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));
        const setFavorites = (set) => localStorage.setItem('favorites', JSON.stringify(Array.from(set)));
        const getTheme = () => localStorage.getItem('theme');
        const setTheme = (t) => localStorage.setItem('theme', t);
        const getState = () => JSON.parse(localStorage.getItem('state') || 'null');
        const setState = (s) => localStorage.setItem('state', JSON.stringify(s));

        const productId = (p) => p.itemName; // 一意と仮定

        const inferTags = (p) => {
            const name = `${p.itemName} ${p.catchcopy}`.toLowerCase();
            const tags = new Set();
            if (name.includes('uv')) tags.add('UVカット');
            if (name.includes('冷感') || name.includes('ひんやり')) tags.add('冷感');
            if (name.includes('ワンピ') || name.includes('onepiece')) tags.add('ワンピース');
            if (name.includes('水着') || name.includes('ラッシュ')) tags.add('水着');
            if (name.includes('パンツ')) tags.add('パンツ');
            if (name.includes('デニム')) tags.add('デニム');
            if (name.includes('ルームウェア')) tags.add('ルームウェア');
            if (name.includes('体型カバー')) tags.add('体型カバー');
            if (name.includes('パーカー')) tags.add('パーカー');
            return Array.from(tags);
        };

        // 正規化用メトリクス
        const metrics = {
            price: { getter: p => p.itemPrice, better: 'lower' },
            rating: { getter: p => p.reviewAverage, better: 'higher' },
            reviews: { getter: p => p.reviewCount, better: 'higher' },
        };

        const state = {
            sortKey: 'rank',
            query: '',
            priceMin: 0,
            priceMax: 0,
            ratingMin: 0,
            reviewMin: 0,
            onlyFavorites: false,
            selectedTags: new Set(),
            weights: { price: 0.34, rating: 0.33, reviews: 0.33 },
        };

        let favorites = getFavorites();
        let compareSet = new Set();
        let augmented = productsData.map(p => ({ ...p, tags: inferTags(p) }));
        let priceBounds = { min: Math.min(...augmented.map(p => p.itemPrice)), max: Math.max(...augmented.map(p => p.itemPrice)) };
        state.priceMin = priceBounds.min; state.priceMax = priceBounds.max;

        // UI 初期値
        priceMinInput.value = state.priceMin;
        priceMaxInput.value = state.priceMax;
        priceRangeQuick.value = 0; // 0=全域、右へ行くほど安価寄り
        filterRating.value = state.ratingMin; labelRating.textContent = Number(state.ratingMin).toFixed(1);
        filterReview.value = state.reviewMin; labelReview.textContent = Number(state.reviewMin).toLocaleString();

        // タグ一覧生成
        const allTags = Array.from(new Set(augmented.flatMap(p => p.tags))).sort();
        allTags.forEach(tag => {
            const b = document.createElement('button');
            b.className = 'chip';
            b.textContent = tag;
            b.setAttribute('aria-pressed', 'false');
            b.addEventListener('click', () => {
                if (state.selectedTags.has(tag)) { state.selectedTags.delete(tag); b.classList.remove('chip-selected'); b.setAttribute('aria-pressed', 'false'); }
                else { state.selectedTags.add(tag); b.classList.add('chip-selected'); b.setAttribute('aria-pressed', 'true'); }
                displayResults(state.sortKey);
            });
            tagsContainer.appendChild(b);
        });

        function imgUrlWithSize(url, size) {
            if (!url) return url;
            const hasQuery = url.includes('?');
            const exParam = `_ex=${size}x${size}`;
            if (/_ex=\d+x\d+/.test(url)) {
                return url.replace(/_ex=\d+x\d+/, exParam);
            }
            return url + (hasQuery ? '&' : '?') + exParam;
        }
        function buildSrcset(url) {
            const sizes = [320, 480, 640, 800];
            return sizes.map(s => `${imgUrlWithSize(url, s)} ${s}w`).join(', ');
        }
        function createCard(product) {
            return `
                <div id="card-${product.rank}" class="bg-white rounded-2xl card-shadow card-shadow-hover transition-all transform-gpu opacity-0 translate-y-4" style="transition-delay: ${product.rank * 40}ms;">
                    <img src="${imgUrlWithSize(product.imageUrl, 640)}" srcset="${buildSrcset(product.imageUrl)}" sizes="(min-width:1024px) 320px, (min-width:768px) 45vw, 90vw" alt="${product.itemName}" class="rounded-t-2xl w-full object-contain bg-white" style="aspect-ratio: 1 / 1;" loading="lazy" decoding="async">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <p class="text-xs text-gray-500">RANK ${product.rank}</p>
                                <h3 class="font-bold text-primary leading-tight">${product.itemName}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn favorite-btn" data-id="${product.itemName}" aria-label="お気に入りに追加/解除">${favorites.has(product.itemName) ? '★' : '☆'}</button>
                            <span class="text-lg font-bold text-accent whitespace-nowrap">¥${product.itemPrice.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="text-sm space-y-2 mb-4">
                            <p class="text-gray-600">${product.catchcopy}</p>
                            <div class="flex items-center gap-4 text-xs">
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">⭐ ${product.reviewAverage}</span>
                                <span class="text-gray-500">✍️ ${product.reviewCount.toLocaleString()}件</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${product.tags.map(t => `<span class="chip">${t}</span>`).join('')}
                        </div>
                         <div id="details-${product.rank}" class="text-sm leading-relaxed text-gray-700 bg-stone-50 p-3 rounded-lg hidden mb-4">
                            <p>${product.description}</p>
                        </div>
                        <button onclick="toggleDetails(${product.rank})" class="w-full text-center text-primary font-semibold py-2 rounded-lg border-2 border-primary/30 hover:bg-primary/10 transition-colors">
                            詳細を見る
                        </button>
                        <div class="flex gap-2 mt-3">
                            <label class="inline-flex items-center gap-2 text-sm border rounded-lg px-3 py-2">
                                <input type="checkbox" class="compare-checkbox" data-id="${product.itemName}">
                                比較
                            </label>
                            <button class="btn border rounded-lg px-3 py-2 text-sm share-btn" data-rank="${product.rank}" data-name="${product.itemName}">共有</button>
                            <a href="${product.affiliateUrl}" target="_blank" rel="sponsored nofollow noopener noreferrer" class="block w-full text-center bg-primary text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity flex-1">
                            楽天でチェック
                        </a>
                        <span class="text-[11px] text-muted self-center">PR｜広告</span>
                        </div>
                    </div>
                </div>
            `;
        }

        let productsChart = null;
        let currentData = [];

        function computeScores(list) {
            const values = {
                price: list.map(metrics.price.getter),
                rating: list.map(metrics.rating.getter),
                reviews: list.map(metrics.reviews.getter),
            };
            const minmax = (arr) => ({ min: Math.min(...arr), max: Math.max(...arr) });
            const mm = { price: minmax(values.price), rating: minmax(values.rating), reviews: minmax(values.reviews) };
            const norm = (v, {min, max}, better) => {
                if (max === min) return 0.5; // 同一値
                const t = (v - min) / (max - min);
                return better === 'higher' ? t : 1 - t;
            };
            return list.map(p => {
                const sPrice = norm(p.itemPrice, mm.price, 'lower');
                const sRating = norm(p.reviewAverage, mm.rating, 'higher');
                const sReviews = norm(p.reviewCount, mm.reviews, 'higher');
                const score = sPrice * state.weights.price + sRating * state.weights.rating + sReviews * state.weights.reviews;
                return { ...p, score: Number(score.toFixed(4)) };
            });
        }

        function filterData() {
            const q = state.query.trim().toLowerCase();
            const favoritesFilter = state.onlyFavorites ? favorites : null;
            let list = augmented.filter(p =>
                p.itemPrice >= state.priceMin && p.itemPrice <= state.priceMax &&
                p.reviewAverage >= state.ratingMin &&
                p.reviewCount >= state.reviewMin &&
                (q === '' || `${p.itemName} ${p.catchcopy} ${p.description}`.toLowerCase().includes(q)) &&
                (!favoritesFilter || favoritesFilter.has(productId(p))) &&
                (state.selectedTags.size === 0 || p.tags.some(t => state.selectedTags.has(t)))
            );
            list = computeScores(list);
            return list;
        }

        function displayResults(sortKey) {
            state.sortKey = sortKey;
            resultsContainer.innerHTML = '';
            
            let list = filterData();
            if(sortKey === 'price') list.sort((a,b) => a.itemPrice - b.itemPrice);
            else if (sortKey === 'review') list.sort((a,b) => b.reviewAverage - a.reviewAverage);
            else if (sortKey === 'rank') list.sort((a,b) => a.rank - b.rank);
            else if (sortKey === 'score') list.sort((a,b) => b.score - a.score);

            // 画面挿入（ランクは表示用連番）
            list.forEach((product, index) => {
                const temp = { ...product, rank: index + 1 };
                resultsContainer.insertAdjacentHTML('beforeend', createCard(temp));
            });

            // アニメーション
            setTimeout(() => {
                list.forEach((_, index) => {
                    const card = document.getElementById(`card-${index + 1}`);
                    if(card) card.classList.remove('opacity-0', 'translate-y-4');
                });
            }, 10);

            // ボタン状態
            for (const key in sortButtons) {
                if(key === sortKey) { sortButtons[key].classList.remove('bg-accent'); sortButtons[key].classList.add('bg-primary', 'ring-2', 'ring-offset-2'); sortButtons[key].setAttribute('aria-selected','true'); }
                else { sortButtons[key].classList.remove('bg-primary', 'ring-2', 'ring-offset-2'); sortButtons[key].classList.add('bg-accent'); sortButtons[key].setAttribute('aria-selected','false'); }
            }

            // おすすめ順ボタン
            if (sortKey === 'score') btnSortScore.classList.add('ring-2', 'ring-offset-2'); else btnSortScore.classList.remove('ring-2', 'ring-offset-2');

            // 共有/お気に入り/比較 イベント
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (favorites.has(id)) favorites.delete(id); else favorites.add(id);
                    setFavorites(favorites);
                    btn.textContent = favorites.has(id) ? '★' : '☆';
                    if (state.onlyFavorites) displayResults(state.sortKey);
                });
            });
            document.querySelectorAll('.compare-checkbox').forEach(chk => {
                const id = chk.dataset.id;
                chk.checked = compareSet.has(id);
                chk.addEventListener('change', () => {
                    if (chk.checked) {
                        if (compareSet.size >= 3) { chk.checked = false; return; }
                        compareSet.add(id);
                } else {
                        compareSet.delete(id);
                    }
                    updateCompareBar();
                });
            });
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const rank = btn.dataset.rank;
                    const name = btn.dataset.name;
                    const url = `${location.origin}${location.pathname}#card-${rank}`;
                    try {
                        if (navigator.share) await navigator.share({ title: name, url });
                        else { await navigator.clipboard.writeText(url); btn.textContent = 'コピー済み'; setTimeout(()=>btn.textContent='共有',1500); }
                    } catch {}
                });
            });

            currentData = list;
            refreshChart(list);
            resultSummary.textContent = `${list.length} 件表示中`;
            setState({ ...state, selectedTags: Array.from(state.selectedTags) });
        }

        function updateCompareBar() {
            compareCount.textContent = compareSet.size;
            btnCompare.disabled = compareSet.size < 2;
            compareBar.classList.toggle('hidden', compareSet.size === 0);
        }

        function openCompareModal() {
            const ids = Array.from(compareSet);
            const items = augmented.filter(p => ids.includes(productId(p)));
            const best = {
                price: Math.min(...items.map(p => p.itemPrice)),
                rating: Math.max(...items.map(p => p.reviewAverage)),
                reviews: Math.max(...items.map(p => p.reviewCount)),
            };
            const html = `
                <table class="w-full text-sm">
                    <thead>
                        <tr>
                            <th class="text-left p-2">項目</th>
                            ${items.map(p => `<th class="text-left p-2">${p.itemName}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2">価格</td>
                            ${items.map(p => `<td class="p-2 ${p.itemPrice===best.price?'bg-yellow-50 ring-1 ring-yellow-200':''}">¥${p.itemPrice.toLocaleString()}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="p-2">評価</td>
                            ${items.map(p => `<td class="p-2 ${p.reviewAverage===best.rating?'bg-yellow-50 ring-1 ring-yellow-200':''}">⭐ ${p.reviewAverage}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="p-2">レビュー件数</td>
                            ${items.map(p => `<td class="p-2 ${p.reviewCount===best.reviews?'bg-yellow-50 ring-1 ring-yellow-200':''}">${p.reviewCount.toLocaleString()}件</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="p-2">タグ</td>
                            ${items.map(p => `<td class="p-2">${p.tags.map(t=>`<span class='chip'>${t}</span>`).join(' ')}</td>`).join('')}
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('compare-body').innerHTML = html;
            modalBackdrop.style.display = 'flex';
        }

        function refreshChart(list) {
            const ctx = document.getElementById('productsChart').getContext('2d');
            const dataPoints = list.map((p, i) => ({
                x: p.itemPrice,
                y: p.reviewAverage,
                r: Math.max(5, Math.sqrt(p.reviewCount) / 10),
                label: `[${i+1}位] ${p.itemName}`,
                id: productId(p)
            }));
            if (!productsChart) {
                productsChart = new Chart(ctx, {
                    type: 'bubble',
                    data: { datasets: [{ label: '商品', data: dataPoints, backgroundColor: 'rgba(168, 135, 103, 0.6)', borderColor: 'rgba(168, 135, 103, 1)', borderWidth: 1 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: { label: (ctx) => [ `${ctx.raw.label}`, `価格: ${ctx.raw.x.toLocaleString()}円`, `評価: ${ctx.raw.y}` ] }
                            }
                        },
                        onClick: (_, elements) => {
                            if (elements.length) {
                                const idx = elements[0].index;
                                const el = document.getElementById(`card-${idx+1}`);
                                if (el) {
                                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    el.classList.add('highlight-ring');
                                    setTimeout(()=>el.classList.remove('highlight-ring'), 1800);
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: '価格（円）', font: { size: 14 } }, ticks: { callback: (v) => v.toLocaleString() } },
                            y: { title: { display: true, text: 'レビュー評価', font: { size: 14 } }, min: 4.0, max: 4.6 },
                        }
                    }
                });
            } else {
                productsChart.data.datasets[0].data = dataPoints;
                productsChart.update();
            }
        }

        function toggleDetails(rank) {
            const details = document.getElementById(`details-${rank}`);
            const button = details.nextElementSibling;
            details.classList.toggle('hidden');
             if (details.classList.contains('hidden')) {
                button.textContent = '詳細を見る';
            } else {
                button.textContent = '閉じる';
            }
        }

        sortButtons.rank.addEventListener('click', () => displayResults('rank'));
        sortButtons.price.addEventListener('click', () => displayResults('price'));
        sortButtons.review.addEventListener('click', () => displayResults('review'));
        btnSortScore.addEventListener('click', () => displayResults('score'));
        btnReset.addEventListener('click', () => {
            state.query = '';
            state.priceMin = priceBounds.min; state.priceMax = priceBounds.max;
            state.ratingMin = 0; state.reviewMin = 0; state.onlyFavorites = false; state.selectedTags.clear();
            searchBox.value = ''; priceMinInput.value = state.priceMin; priceMaxInput.value = state.priceMax;
            filterRating.value = 0; labelRating.textContent = '0.0';
            filterReview.value = 0; labelReview.textContent = '0';
            Array.from(tagsContainer.children).forEach(el=>el.classList.remove('chip-selected'));
            favOnlyCheckbox.checked = false;
            displayResults('rank');
        });

        const syncPriceQuick = () => {
            // クイックスライダー: 右ほど安価寄り（下位x%の価格帯へMaxを合わせる）
            const t = Number(priceRangeQuick.value) / 100; // 0..1
            const span = priceBounds.max - priceBounds.min;
            state.priceMin = priceBounds.min;
            state.priceMax = Math.round(priceBounds.max - span * t);
            priceMinInput.value = state.priceMin; priceMaxInput.value = state.priceMax;
        };

        searchBox.addEventListener('input', debounce((e) => { state.query = e.target.value; displayResults(state.sortKey); }));
        priceMinInput.addEventListener('change', (e) => { state.priceMin = Number(e.target.value); displayResults(state.sortKey); });
        priceMaxInput.addEventListener('change', (e) => { state.priceMax = Number(e.target.value); displayResults(state.sortKey); });
        priceRangeQuick.addEventListener('input', () => { syncPriceQuick(); displayResults(state.sortKey); });
        filterRating.addEventListener('input', (e) => { state.ratingMin = Number(e.target.value); labelRating.textContent = state.ratingMin.toFixed(1); displayResults(state.sortKey); });
        filterReview.addEventListener('input', (e) => { state.reviewMin = Number(e.target.value); labelReview.textContent = state.reviewMin.toLocaleString(); displayResults(state.sortKey); });
        favOnlyCheckbox.addEventListener('change', (e) => { state.onlyFavorites = e.target.checked; displayResults(state.sortKey); });
        btnCompare.addEventListener('click', openCompareModal);
        btnCompareClear.addEventListener('click', () => { compareSet.clear(); updateCompareBar(); document.querySelectorAll('.compare-checkbox').forEach(x=>x.checked=false); });
        modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) modalBackdrop.style.display = 'none'; });
        modalBackdrop.querySelector('#modal-close').addEventListener('click', () => modalBackdrop.style.display = 'none');

        // ダークモード
        const applyTheme = (t) => {
            if (t === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            btnDarkToggle.textContent = document.documentElement.classList.contains('dark') ? '☀️ ライト' : '🌙 ダーク';
            btnDarkToggle.setAttribute('aria-pressed', document.documentElement.classList.contains('dark'));
        };
        const preferred = getTheme() || 'light';
        applyTheme(preferred);
        btnDarkToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            setTheme(isDark ? 'dark' : 'light');
            btnDarkToggle.textContent = isDark ? '☀️ ライト' : '🌙 ダーク';
            displayResults(state.sortKey);
        });

        // PWA install
        let deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; btnInstall.classList.remove('hidden');
        });
        btnInstall.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; btnInstall.classList.add('hidden'); });

        // SW 登録
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('../../sw.js').catch(()=>{}); }


        // 初期チャートは displayResults 内で生成

        // 初期表示
        (function initFromState(){
            const saved = getState();
            if (saved) {
                state.sortKey = saved.sortKey || 'rank';
                state.query = saved.query || '';
                state.priceMin = saved.priceMin ?? priceBounds.min;
                state.priceMax = saved.priceMax ?? priceBounds.max;
                state.ratingMin = saved.ratingMin || 0;
                state.reviewMin = saved.reviewMin || 0;
                state.onlyFavorites = saved.onlyFavorites || false;
                state.selectedTags = new Set(saved.selectedTags || []);
                // 反映
                searchBox.value = state.query;
                priceMinInput.value = state.priceMin; priceMaxInput.value = state.priceMax;
                filterRating.value = state.ratingMin; labelRating.textContent = state.ratingMin.toFixed(1);
                filterReview.value = state.reviewMin; labelReview.textContent = state.reviewMin.toLocaleString();
                Array.from(tagsContainer.children).forEach(el => { if (state.selectedTags.has(el.textContent)) el.classList.add('chip-selected'); });
                favOnlyCheckbox.checked = state.onlyFavorites;
            }
            displayResults(state.sortKey);
            // ハッシュリンク対応
            if (location.hash.startsWith('#card-')) { const el = document.querySelector(location.hash); if (el) setTimeout(()=>el.scrollIntoView({behavior:'smooth'}), 300); }
        })();

        // データ更新日表示
        document.getElementById('data-updated').textContent = new Date().toISOString().slice(0,10);

        // 総合トップ3（scoreベース）
        (function renderTop3(){
            const list = computeScores([...augmented]).sort((a,b)=> b.score - a.score).slice(0,3);
            const el = document.getElementById('top3-container');
            el.innerHTML = list.map(p => `
                <div class="bg-white rounded-2xl card-shadow card-shadow-hover transition-all transform-gpu">
                    <img src="${imgUrlWithSize(p.imageUrl, 640)}" srcset="${buildSrcset(p.imageUrl)}" sizes="(min-width:1024px) 320px, (min-width:768px) 30vw, 90vw" alt="${p.itemName}" loading="lazy" decoding="async" class="rounded-t-2xl w-full object-contain bg-white" style="aspect-ratio: 1 / 1;">
                    <div class="p-5">
                        <p class="text-xs text-gray-500">おすすめ</p>
                        <h3 class="font-bold text-primary leading-tight mb-1">${p.itemName}</h3>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-lg font-bold text-accent">¥${p.itemPrice.toLocaleString()}</span>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">⭐ ${p.reviewAverage}</span>
                        </div>
                        <a href="${p.affiliateUrl}" target="_blank" rel="sponsored nofollow noopener noreferrer" class="block w-full text-center bg-primary text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">楽天でチェック</a>
                        <span class="block text-center text-[11px] text-muted mt-1">PR｜広告</span>
                    </div>
                </div>
            `).join('');
        })();

        // JSON-LD（ItemList）
        (function injectJsonLd(){
            try {
                const itemList = {
                    '@context': 'https://schema.org',
                    '@type': 'ItemList',
                    'itemListElement': productsData.map((p, idx)=>({
                        '@type': 'ListItem',
                        'position': idx + 1,
                        'url': p.affiliateUrl,
                        'item': {
                            '@type': 'Product',
                            'name': p.itemName,
                            'image': p.imageUrl,
                            'description': p.catchcopy,
                            'aggregateRating': {
                                '@type': 'AggregateRating',
                                'ratingValue': p.reviewAverage,
                                'reviewCount': p.reviewCount
                            },
                            'offers': {
                                '@type': 'Offer',
                                'priceCurrency': 'JPY',
                                'price': p.itemPrice,
                                'url': p.affiliateUrl,
                                'availability': 'https://schema.org/InStock'
                            }
                        }
                    }))
                };
                const s = document.createElement('script');
                s.type = 'application/ld+json';
                s.text = JSON.stringify(itemList);
                document.head.appendChild(s);
            } catch {}
        })();

        // detailsを開いたときにグラフを初期化/再描画
        (function bindDetailsChart(){
            const detailsEl = document.querySelector('#chart-analysis details');
            if (!detailsEl) return;
            detailsEl.addEventListener('toggle', () => {
                if (detailsEl.open) {
                    // 短い遅延でChart.jsが完全にロードされるのを待つ
                    setTimeout(() => {
                        if (!productsChart) {
                            const list = currentData && currentData.length ? currentData : filterData();
                            // 初回はここで初期化（closed状態で生成しない）
                            refreshChart(list);
                        } else {
                            // サイズ再計算のみでOK
                            setTimeout(() => { try { productsChart.resize(); } catch {} }, 50);
                        }
                    }, 100);
                }
            });
            // もし初期状態で開いていれば即生成
            if (detailsEl.open) {
                setTimeout(() => {
                    const list = currentData && currentData.length ? currentData : filterData();
                    refreshChart(list);
                }, 200);
            }
        })();
    </script>
    
    <!-- 読み込み完了後にbodyを表示するためのスクリプト -->
    <script>
        window.onload = function() {
            document.body.style.display = "block";
        };
    </script>
</body>
</html>